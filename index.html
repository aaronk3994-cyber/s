<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>One-Shot Extraction: Advanced</title>
    <style>
        body { margin: 0; background: #0d1117; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        .ui { margin-bottom: 10px; font-weight: bold; font-size: 1.2rem; display: flex; gap: 30px; }
        canvas { background: #161b22; border: 3px solid #30363d; border-radius: 8px; cursor: crosshair; }
        #msg { position: absolute; font-size: 3rem; font-weight: 900; pointer-events: none; text-shadow: 2px 2px 10px rgba(0,0,0,0.5); }
    </style>
</head>
<body>
    <div class="ui">
        <div>LEVEL: <span id="lvl">1</span></div>
        <div>ENEMIES: <span id="ec">0</span></div>
        <div id="ammo-txt">AMMO: READY</div>
    </div>
    <div id="msg"></div>
    <canvas id="gameCanvas" width="900" height="550"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const msg = document.getElementById('msg');

let currentLevel = 1;
let player = { x: 450, y: 275, size: 22, speed: 4.5, hasAmmo: true, alive: true, flash: 0, angle: 0 };
let bullet = { x: 0, y: 0, vx: 0, vy: 0, active: false, onGround: false, pulse: 0 };
let enemies = [];
let keys = {};

// Level Configurations
function initLevel(lvl) {
    enemies = [];
    player.x = 450; player.y = 275;
    player.hasAmmo = true;
    bullet.active = false;
    
    // Level scaling logic
    let enemyCount = 2 + lvl; 
    let speedBoost = lvl * 0.2;

    for(let i=0; i<enemyCount; i++) {
        let edge = Math.floor(Math.random() * 4);
        let ex, ey;
        if(edge === 0) { ex = 50; ey = Math.random()*550; } // Left
        else if(edge === 1) { ex = 850; ey = Math.random()*550; } // Right
        else if(edge === 2) { ex = Math.random()*900; ey = 50; } // Top
        else { ex = Math.random()*900; ey = 500; } // Bottom
        
        enemies.push({ x: ex, y: ey, size: 22, speed: 1.2 + speedBoost, alive: true });
    }
    document.getElementById('lvl').innerText = lvl;
}

// Input
window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
canvas.addEventListener('mousemove', e => {
    const rect = canvas.getBoundingClientRect();
    player.angle = Math.atan2((e.clientY-rect.top)-player.y, (e.clientX-rect.left)-player.x);
});
canvas.addEventListener('mousedown', () => {
    if(player.hasAmmo && player.alive) {
        bullet = { x: player.x, y: player.y, vx: Math.cos(player.angle)*14, vy: Math.sin(player.angle)*14, active: true, onGround: false };
        player.hasAmmo = false;
        player.flash = 6;
    }
});

function drawAgent(x, y, angle, color, isEnemy) {
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(angle);
    
    // Body
    ctx.fillStyle = color;
    ctx.fillRect(-12, -12, 24, 24);
    
    // Eyes
    ctx.fillStyle = "white";
    ctx.fillRect(4, -8, 6, 6);
    ctx.fillRect(4, 2, 6, 6);
    ctx.fillStyle = "black";
    ctx.fillRect(7, -6, 3, 3);
    ctx.fillRect(7, 4, 3, 3);
    
    // Gun/Hands
    if(!isEnemy && player.hasAmmo) {
        ctx.fillStyle = "#333";
        ctx.fillRect(10, 5, 12, 5);
    }
    ctx.restore();
}

function update() {
    if(!player.alive) return;

    // Player Move
    if(keys['w'] && player.y > 20) player.y -= player.speed;
    if(keys['s'] && player.y < 530) player.y += player.speed;
    if(keys['a'] && player.x > 20) player.x -= player.speed;
    if(keys['d'] && player.x < 880) player.x += player.speed;

    // Bullet logic
    if(bullet.active && !bullet.onGround) {
        bullet.x += bullet.vx;
        bullet.y += bullet.vy;
        enemies.forEach(en => {
            if(en.alive && Math.hypot(bullet.x-en.x, bullet.y-en.y) < 22) {
                en.alive = false;
                bullet.onGround = true;
            }
        });
        if(bullet.x<0 || bullet.x>900 || bullet.y<0 || bullet.y>550) bullet.onGround = true;
    }

    if(bullet.onGround && Math.hypot(player.x-bullet.x, player.y-bullet.y) < 25) {
        player.hasAmmo = true; bullet.active = false;
    }

    // Enemy AI
    let aliveCount = 0;
    enemies.forEach(en => {
        if(en.alive) {
            aliveCount++;
            let ang = Math.atan2(player.y-en.y, player.x-en.x);
            en.x += Math.cos(ang) * en.speed;
            en.y += Math.sin(ang) * en.speed;
            en.angle = ang;
            if(Math.hypot(player.x-en.x, player.y-en.y) < 20) {
                player.alive = false;
                msg.innerText = "EXTRACTED BY FORCE";
                msg.style.color = "#f85149";
            }
        }
    });

    document.getElementById('ec').innerText = aliveCount;
    document.getElementById('ammo-txt').innerText = player.hasAmmo ? "AMMO: READY" : "AMMO: OUT";
    document.getElementById('ammo-txt').style.color = player.hasAmmo ? "#d29922" : "#f85149";

    if(aliveCount === 0) {
        currentLevel++;
        initLevel(currentLevel);
    }
}

function draw() {
    ctx.clearRect(0, 0, 900, 550);

    // Draw Bullet
    if(bullet.active) {
        if(bullet.onGround) {
            bullet.pulse += 0.1;
            ctx.shadowBlur = 10 + Math.sin(bullet.pulse) * 5;
            ctx.shadowColor = "gold";
        }
        ctx.fillStyle = bullet.onGround ? "gold" : "white";
        ctx.beginPath(); ctx.arc(bullet.x, bullet.y, 5, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
    }

    // Draw Agents
    enemies.forEach(en => { if(en.alive) drawAgent(en.x, en.y, en.angle, "#f85149", true); });
    if(player.alive) drawAgent(player.x, player.y, player.angle, "#58a6ff", false);

    // Muzzle Flash
    if(player.flash > 0) {
        ctx.fillStyle = `rgba(255, 255, 255, ${player.flash/6})`;
        ctx.beginPath(); ctx.arc(player.x + Math.cos(player.angle)*20, player.y + Math.sin(player.angle)*20, 30, 0, Math.PI*2); ctx.fill();
        player.flash--;
    }

    requestAnimationFrame(() => { update(); draw(); });
}

initLevel(1);
draw();
</script>
</body>
</html>
