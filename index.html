<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>One-Shot Extraction | Pro Edition</title>
    <style>
        :root { --bg: #0d1117; --accent: #58a6ff; --gold: #d29922; --danger: #f85149; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; touch-action: none; }
        
        /* UI Header */
        .ui-header { display: flex; gap: 10px; margin-bottom: 10px; z-index: 10; }
        .card { background: rgba(22, 27, 34, 0.9); padding: 8px 15px; border-radius: 8px; border: 1px solid #30363d; font-size: 0.9rem; }
        
        /* Toggle Button */
        #ctrl-toggle { 
            background: #21262d; color: white; border: 1px solid #30363d; 
            padding: 8px 15px; border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        #ctrl-toggle.active { background: var(--accent); border-color: white; }

        canvas { background: #161b22; border: 2px solid #30363d; border-radius: 10px; cursor: crosshair; max-width: 95vw; max-height: 70vh; }

        /* Dynamic Joystick */
        #joystick-container {
            position: absolute; width: 100px; height: 100px;
            background: rgba(255,255,255,0.1); border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.2); display: none; pointer-events: none;
        }
        #joystick-knob {
            position: absolute; width: 40px; height: 40px;
            background: var(--accent); border-radius: 50%;
            left: 30px; top: 30px;
        }
    </style>
</head>
<body>

    <div class="ui-header">
        <div class="card">LVL: <span id="lvl">1</span></div>
        <div class="card">SCORE: <span id="score">0</span></div>
        <button id="ctrl-toggle">JOYSTICK: ON</button>
    </div>

    <canvas id="gameCanvas" width="900" height="550"></canvas>

    <div id="joystick-container"><div id="joystick-knob"></div></div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const toggleBtn = document.getElementById('ctrl-toggle');
const joystick = document.getElementById('joystick-container');
const knob = document.getElementById('joystick-knob');

// --- GAME STATE ---
let score = 0, currentLevel = 1, shake = 0;
let player = { x: 450, y: 275, size: 22, speed: 4.5, hasAmmo: true, alive: true, angle: 0 };
let bullet = { x: 0, y: 0, vx: 0, vy: 0, active: false, onGround: false };
let enemies = [], enemyProjectiles = [], keys = {};

// --- CONTROL SETTINGS ---
let joystickEnabled = true;
let joyX = 0, joyY = 0, touchId = null;

toggleBtn.onclick = () => {
    joystickEnabled = !joystickEnabled;
    toggleBtn.innerText = `JOYSTICK: ${joystickEnabled ? 'ON' : 'OFF'}`;
    toggleBtn.classList.toggle('active', joystickEnabled);
};

// --- INPUT HANDLING ---
window.onkeydown = e => keys[e.key.toLowerCase()] = true;
window.onkeyup = e => keys[e.key.toLowerCase()] = false;

canvas.onmousemove = (e) => {
    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left) * (canvas.width / rect.width);
    const my = (e.clientY - rect.top) * (canvas.height / rect.height);
    player.angle = Math.atan2(my - player.y, mx - player.x);
};

canvas.onmousedown = () => shoot();

// Mobile Touch Logic
window.addEventListener('touchstart', (e) => {
    for (let t of e.changedTouches) {
        if (joystickEnabled && t.clientX < window.innerWidth / 2 && touchId === null) {
            touchId = t.identifier;
            joystick.style.display = 'block';
            joystick.style.left = (t.clientX - 50) + 'px';
            joystick.style.top = (t.clientY - 50) + 'px';
        } else {
            const rect = canvas.getBoundingClientRect();
            const mx = (t.clientX - rect.left) * (canvas.width / rect.width);
            const my = (t.clientY - rect.top) * (canvas.height / rect.height);
            player.angle = Math.atan2(my - player.y, mx - player.x);
            shoot();
        }
    }
}, {passive: false});

window.addEventListener('touchmove', (e) => {
    if (!joystickEnabled) return;
    for (let t of e.changedTouches) {
        if (t.identifier === touchId) {
            const rect = joystick.getBoundingClientRect();
            let dx = t.clientX - (rect.left + 50), dy = t.clientY - (rect.top + 50);
            const dist = Math.hypot(dx, dy);
            if (dist > 40) { dx *= 40/dist; dy *= 40/dist; }
            knob.style.transform = `translate(${dx}px, ${dy}px)`;
            joyX = dx / 40; joyY = dy / 40;
        }
    }
}, {passive: false});

window.addEventListener('touchend', (e) => {
    for (let t of e.changedTouches) {
        if (t.identifier === touchId) {
            touchId = null; joystick.style.display = 'none';
            joyX = 0; joyY = 0;
        }
    }
});

function shoot() {
    if (!player.hasAmmo || !player.alive) return;
    bullet = { x: player.x, y: player.y, vx: Math.cos(player.angle)*15, vy: Math.sin(player.angle)*15, active: true, onGround: false };
    player.hasAmmo = false; shake = 12;
}

// --- CORE LOOP ---
function initLevel(lvl) {
    enemies = []; enemyProjectiles = [];
    player.hasAmmo = true; bullet.active = false;
    if (lvl % 10 === 0) {
        enemies.push({ x: 100, y: 100, size: 55, speed: 1.1, hp: 3, isBoss: true, alive: true, lastShot: 0 });
    } else {
        for(let i=0; i<2+lvl; i++) {
            enemies.push({ x: Math.random()*900, y: Math.random()*550, size: 22, speed: 1.3+(lvl*0.1), alive: true, hp: 1, isBoss: false });
        }
    }
    document.getElementById('lvl').innerText = lvl;
}

function update() {
    if (!player.alive) return;
    if (shake > 0) shake *= 0.9;

    // Movement (Keys or Joystick)
    let kx = (keys['d'] ? 1 : keys['a'] ? -1 : 0);
    let ky = (keys['s'] ? 1 : keys['w'] ? -1 : 0);
    player.x += (kx || joyX) * player.speed;
    player.y += (ky || joyY) * player.speed;

    // Bullet vs Enemies
    if (bullet.active && !bullet.onGround) {
        bullet.x += bullet.vx; bullet.y += bullet.vy;
        enemies.forEach(en => {
            if (en.alive && Math.hypot(bullet.x-en.x, bullet.y-en.y) < en.size) {
                en.hp--; shake = 15;
                if (en.hp <= 0) en.alive = false;
                bullet.onGround = true;
            }
        });
        if(bullet.x<0 || bullet.x>900 || bullet.y<0 || bullet.y>550) bullet.onGround = true;
    }

    // Pickup
    if (bullet.onGround && Math.hypot(player.x-bullet.x, player.y-bullet.y) < 25) {
        player.hasAmmo = true; bullet.active = false;
    }

    // AI & Collision
    let aliveCount = 0;
    enemies.forEach(en => {
        if (!en.alive) return;
        aliveCount++;
        let ang = Math.atan2(player.y-en.y, player.x-en.x);
        en.x += Math.cos(ang) * en.speed;
        en.y += Math.sin(ang) * en.speed;
        if (en.isBoss && Date.now() - en.lastShot > 500) {
            enemyProjectiles.push({ x: en.x, y: en.y, vx: Math.cos(ang)*9, vy: Math.sin(ang)*9 });
            en.lastShot = Date.now();
        }
        if (Math.hypot(player.x-en.x, player.y-en.y) < en.size) player.alive = false;
    });

    enemyProjectiles.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy;
        if (Math.hypot(p.x-player.x, p.y-player.y) < 15) player.alive = false;
    });

    if (aliveCount === 0) { score += 100; currentLevel++; initLevel(currentLevel); document.getElementById('score').innerText = score; }
}

function drawAgent(x, y, angle, color, size) {
    ctx.save(); ctx.translate(x, y); ctx.rotate(angle);
    ctx.fillStyle = color; ctx.fillRect(-size/2, -size/2, size, size);
    ctx.fillStyle = "white"; ctx.fillRect(size/4, -size/3, size/4, size/4); ctx.fillRect(size/4, size/12, size/4, size/4);
    ctx.restore();
}

function draw() {
    ctx.save();
    if (shake > 0.5) ctx.translate(Math.random()*shake-shake/2, Math.random()*shake-shake/2);
    ctx.clearRect(0, 0, 900, 550);

    enemyProjectiles.forEach(p => { ctx.fillStyle = "#ff00ff"; ctx.fillRect(p.x-5, p.y-2, 12, 4); });
    if (bullet.active) {
        ctx.fillStyle = bullet.onGround ? "gold" : "white";
        ctx.beginPath(); ctx.arc(bullet.x, bullet.y, 6, 0, Math.PI*2); ctx.fill();
    }
    enemies.forEach(en => { if(en.alive) drawAgent(en.x, en.y, Math.atan2(player.y-en.y, player.x-en.x), "#f85149", en.size); });
    if (player.alive) drawAgent(player.x, player.y, player.angle, "#58a6ff", 24);
    
    ctx.restore();
    update();
    requestAnimationFrame(draw);
}

initLevel(1);
draw();
</script>
</body>
</html>
