const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// Game State
let score = 0, currentLevel = 1, shake = 0;
let player = { x: 450, y: 275, size: 22, speed: 4.5, hasAmmo: true, alive: true, flash: 0, angle: 0 };
let bullet = { x: 0, y: 0, vx: 0, vy: 0, active: false, onGround: false };
let enemies = [];
let enemyProjectiles = []; // New: Boss lasers
let keys = {};

// Joystick logic (Keep previous touch logic here...)

function initLevel(lvl) {
    enemies = [];
    enemyProjectiles = [];
    player.x = 450; player.y = 275;
    player.hasAmmo = true;
    bullet.active = false;

    if (lvl % 10 === 0) {
        // BOSS LEVEL
        enemies.push({ 
            x: 100, y: 100, size: 50, speed: 1, 
            hp: 3, isBoss: true, alive: true, 
            angle: 0, lastShot: 0, shootDelay: 400 // Matches player fire speed
        });
    } else {
        // NORMAL LEVEL
        for(let i=0; i < 2 + lvl; i++) {
            enemies.push({ x: Math.random()*900, y: Math.random()*550, size: 22, speed: 1.2 + (lvl*0.1), alive: true, hp: 1, isBoss: false });
        }
    }
    document.getElementById('lvl').innerText = lvl;
}

function update() {
    if(!player.alive) return;
    if (shake > 0) shake *= 0.9;

    // Player Movement (Joystick/Keys)
    let moveX = (keys['d'] ? 1 : keys['a'] ? -1 : 0);
    let moveY = (keys['s'] ? 1 : keys['w'] ? -1 : 0);
    player.x += moveX * player.speed;
    player.y += moveY * player.speed;

    // Player Bullet Logic
    if(bullet.active && !bullet.onGround) {
        bullet.x += bullet.vx; bullet.y += bullet.vy;
        enemies.forEach(en => {
            if(en.alive && Math.hypot(bullet.x-en.x, bullet.y-en.y) < en.size) {
                en.hp--;
                shake = 8;
                if(en.hp <= 0) en.alive = false;
                bullet.onGround = true; // Bullet drops even if boss isn't dead
            }
        });
        if(bullet.x<0 || bullet.x>900 || bullet.y<0 || bullet.y>550) bullet.onGround = true;
    }

    // Boss Shooting Logic
    enemies.forEach(en => {
        if(en.alive && en.isBoss) {
            let now = Date.now();
            if(now - en.lastShot > en.shootDelay) {
                let ang = Math.atan2(player.y - en.y, player.x - en.x);
                enemyProjectiles.push({ 
                    x: en.x, y: en.y, 
                    vx: Math.cos(ang) * 10, vy: Math.sin(ang) * 10 
                });
                en.lastShot = now;
            }
        }
    });

    // Boss Lasers vs Player
    enemyProjectiles.forEach((p, index) => {
        p.x += p.vx; p.y += p.vy;
        if(Math.hypot(p.x - player.x, p.y - player.y) < player.size) player.alive = false;
        if(p.x < 0 || p.x > 900 || p.y < 0 || p.y > 550) enemyProjectiles.splice(index, 1);
    });

    // Enemy AI & Player Death
    let aliveCount = 0;
    enemies.forEach(en => {
        if(en.alive) {
            aliveCount++;
            let ang = Math.atan2(player.y-en.y, player.x-en.x);
            en.x += Math.cos(ang) * en.speed;
            en.y += Math.sin(ang) * en.speed;
            if(Math.hypot(player.x-en.x, player.y-en.y) < en.size) player.alive = false;
        }
    });

    if(aliveCount === 0) { currentLevel++; initLevel(currentLevel); }
}

function draw() {
    ctx.save();
    if (shake > 0.5) ctx.translate(Math.random()*shake, Math.random()*shake);
    ctx.clearRect(0, 0, 900, 550);

    // Draw Boss Lasers
    ctx.fillStyle = "#ff00ff";
    enemyProjectiles.forEach(p => {
        ctx.fillRect(p.x-2, p.y-2, 15, 4); // Laser look
    });

    // Draw Bullet
    if(bullet.active) {
        ctx.fillStyle = bullet.onGround ? "gold" : "white";
        ctx.beginPath(); ctx.arc(bullet.x, bullet.y, 6, 0, Math.PI*2); ctx.fill();
    }

    // Draw Enemies & Bosses
    enemies.forEach(en => {
        if(en.alive) {
            if(en.isBoss) {
                drawBoss(en.x, en.y, en.hp);
            } else {
                drawAgent(en.x, en.y, Math.atan2(player.y-en.y, player.x-en.x), "#f85149");
            }
        }
    });

    if(player.alive) drawAgent(player.x, player.y, player.angle, "#58a6ff");
    else { ctx.fillStyle = "white"; ctx.fillText("GAME OVER", 400, 275); }

    ctx.restore();
    requestAnimationFrame(() => { update(); draw(); });
}

function drawBoss(x, y, hp) {
    // Large armored look
    ctx.fillStyle = "#941e1e";
    ctx.fillRect(x-25, y-25, 50, 50);
    ctx.strokeStyle = "white";
    ctx.lineWidth = 2;
    ctx.strokeRect(x-25, y-25, 50, 50);
    
    // Boss HP bar
    ctx.fillStyle = "red";
    ctx.fillRect(x-25, y-35, (hp/3)*50, 5);
}

function drawAgent(x, y, angle, color) {
    ctx.save(); ctx.translate(x, y); ctx.rotate(angle);
    ctx.fillStyle = color; ctx.fillRect(-12, -12, 24, 24);
    ctx.fillStyle = "white"; ctx.fillRect(5, -9, 6, 6); ctx.fillRect(5, 3, 6, 6);
    ctx.restore();
}

initLevel(1);
draw();
