<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>One-Shot Extraction | Pro Build</title>
    <style>
        :root { --bg: #0d1117; --panel: #161b22; --accent: #58a6ff; --gold: #d29922; --danger: #f85149; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; touch-action: none; }
        .ui-layer { position: absolute; top: 20px; display: flex; gap: 10px; z-index: 10; }
        .card { background: var(--panel); padding: 10px 15px; border-radius: 8px; border: 1px solid #30363d; font-weight: bold; }
        .wep-btn { cursor: pointer; border: 1px solid #30363d; background: #21262d; color: #8b949e; transition: 0.2s; }
        .wep-btn.active { border-color: var(--accent); color: white; box-shadow: 0 0 10px rgba(88, 166, 255, 0.3); }
        canvas { background: #000; border: 2px solid #30363d; border-radius: 12px; max-width: 95vw; max-height: 70vh; cursor: crosshair; }
        #joystick-container { position: absolute; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); display: none; pointer-events: none; }
        #joystick-knob { position: absolute; width: 40px; height: 40px; background: var(--accent); border-radius: 50%; left: 30px; top: 30px; }
        #msg-overlay { position: absolute; font-weight: 900; text-align: center; pointer-events: none; text-shadow: 0 0 20px black; z-index: 20; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
    </style>
</head>
<body>

    <div class="ui-layer">
        <div class="card">LVL: <span id="lvl">1</span></div>
        <div class="card">SCORE: <span id="score">0</span></div>
        <button id="wep-P" class="card wep-btn active" onclick="setWeapon('PISTOL')">PISTOL</button>
        <button id="wep-S" class="card wep-btn" onclick="setWeapon('SHOTGUN')">SHOTGUN</button>
        <button id="wep-X" class="card wep-btn" onclick="setWeapon('SNIPER')">SNIPER</button>
    </div>

    <div id="msg-overlay"></div>
    <canvas id="gameCanvas" width="900" height="550"></canvas>
    <div id="joystick-container"><div id="joystick-knob"></div></div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const msgOverlay = document.getElementById('msg-overlay');

// --- AUDIO ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playPing() {
    try {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    } catch(e){}
}

const WEAPONS = {
    PISTOL: { pellets: 1, spread: 0, speed: 16, color: "#fff", piercing: false, name: "P" },
    SHOTGUN: { pellets: 6, spread: 0.5, speed: 11, color: "#ffaa00", piercing: false, name: "S" },
    SNIPER: { pellets: 1, spread: 0, speed: 28, color: "#00ffff", piercing: true, name: "X" }
};

let player = { x: 450, y: 275, size: 24, speed: 4.8, hasAmmo: true, alive: true, angle: 0, flash: 0 };
let enemies = [], projectiles = [], enemyLasers = [], particles = [];
let score = 0, currentLevel = 1, shake = 0, weapon = WEAPONS.PISTOL;
let keys = {}, joyX = 0, joyY = 0, touchId = null;
let levelLoading = true; 

function initLevel(lvl) {
    levelLoading = true; 
    enemies = []; projectiles = []; enemyLasers = []; particles = [];
    player.x = 450; player.y = 275; player.hasAmmo = true; player.alive = true;
    msgOverlay.innerHTML = "";
    
    let count = (lvl % 10 === 0) ? 1 : 2 + Math.floor(lvl * 0.5);
    for(let i=0; i < count; i++) {
        if(lvl % 10 === 0) {
            enemies.push({ x: 100, y: 100, size: 60, speed: 1.2, hp: 8, isBoss: true, alive: true, lastShot: Date.now(), chargeStart: 0, isCharging: false });
        } else {
            let ex = Math.random() > 0.5 ? -50 : 950;
            let ey = Math.random() * 550;
            enemies.push({ x: ex, y: ey, size: 22, speed: 1.2 + (lvl * 0.05), hp: 1, isBoss: false, alive: true });
        }
    }
    document.getElementById('lvl').innerText = lvl;
    setTimeout(() => { levelLoading = false; }, 100);
}

function spawnParticles(x, y, color) {
    for(let i=0; i<8; i++) {
        particles.push({ x, y, vx: (Math.random()-0.5)*6, vy: (Math.random()-0.5)*6, life: 1.0, color });
    }
}

function respawn() { score = 0; currentLevel = 1; document.getElementById('score').innerText = "0"; initLevel(1); }

// --- INPUTS (FIXED AIMING) ---
window.onkeydown = e => keys[e.key.toLowerCase()] = true;
window.onkeyup = e => keys[e.key.toLowerCase()] = false;

window.addEventListener('mousemove', e => {
    const r = canvas.getBoundingClientRect();
    const mouseX = (e.clientX - r.left) * (canvas.width / r.width);
    const mouseY = (e.clientY - r.top) * (canvas.height / r.height);
    player.angle = Math.atan2(mouseY - player.y, mouseX - player.x);
});

canvas.onmousedown = () => shoot();

window.addEventListener('touchstart', e => {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    for(let t of e.changedTouches) {
        if(t.clientX < window.innerWidth/2 && touchId === null) {
            touchId = t.identifier;
            const joy = document.getElementById('joystick-container');
            joy.style.display = 'block'; joy.style.left = (t.clientX - 50)+'px'; joy.style.top = (t.clientY - 50)+'px';
        } else { shoot(); }
    }
}, {passive: false});

window.addEventListener('touchmove', e => {
    for(let t of e.changedTouches) if(t.identifier === touchId) {
        const r = document.getElementById('joystick-container').getBoundingClientRect();
        let dx = t.clientX - (r.left + 50), dy = t.clientY - (r.top + 50);
        let d = Math.hypot(dx, dy);
        if(d > 40) { dx *= 40/d; dy *= 40/d; }
        document.getElementById('joystick-knob').style.transform = `translate(${dx}px, ${dy}px)`;
        joyX = dx/40; joyY = dy/40;
    }
}, {passive: false});

window.addEventListener('touchend', e => {
    for(let t of e.changedTouches) if(t.identifier === touchId) { 
        touchId = null; joyX = 0; joyY = 0; 
        document.getElementById('joystick-container').style.display = 'none';
    }
});

function setWeapon(type) {
    weapon = WEAPONS[type];
    document.querySelectorAll('.wep-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('wep-' + weapon.name).classList.add('active');
    initLevel(currentLevel);
}

function shoot() {
    if(!player.hasAmmo || !player.alive) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();
    for(let i=0; i<weapon.pellets; i++) {
        let a = player.angle + (Math.random()-0.5) * weapon.spread;
        projectiles.push({ x: player.x, y: player.y, vx: Math.cos(a)*weapon.speed, vy: Math.sin(a)*weapon.speed, active: true, onGround: false, piercing: weapon.piercing });
    }
    player.hasAmmo = false; player.flash = 6; shake = 15;
}

// --- CORE ---
function update() {
    if(!player.alive || levelLoading) return;
    if(shake > 0) shake *= 0.9;

    let mx = joyX || (keys['d']?1 : keys['a']?-1 : 0);
    let my = joyY || (keys['s']?1 : keys['w']?-1 : 0);
    player.x = Math.max(20, Math.min(880, player.x + mx * player.speed));
    player.y = Math.max(20, Math.min(530, player.y + my * player.speed));

    particles.forEach((p, i) => { p.x += p.vx; p.y += p.vy; p.life -= 0.02; if(p.life <= 0) particles.splice(i, 1); });

    projectiles.forEach(p => {
        if(p.active && !p.onGround) {
            p.x += p.vx; p.y += p.vy;
            enemies.forEach(en => {
                if(en.alive && Math.hypot(p.x-en.x, p.y-en.y) < en.size) {
                    en.hp--; shake = 10;
                    if(en.hp <= 0) { en.alive = false; spawnParticles(en.x, en.y, "#f85149"); }
                    if(!p.piercing) p.onGround = true;
                }
            });
            if(p.x < 10) { p.x = 10; p.onGround = true; }
            if(p.x > 890) { p.x = 890; p.onGround = true; }
            if(p.y < 10) { p.y = 10; p.onGround = true; }
            if(p.y > 540) { p.y = 540; p.onGround = true; }
        }
        if(p.onGround && Math.hypot(player.x-p.x, player.y-p.y) < 35) {
            player.hasAmmo = true; projectiles = []; playPing();
        }
    });

    let aliveCount = 0;
    enemies.forEach(en => {
        if(!en.alive) return;
        aliveCount++;
        let a = Math.atan2(player.y-en.y, player.x-en.x);
        en.x += Math.cos(a)*en.speed; en.y += Math.sin(a)*en.speed;
        if(en.isBoss) {
            let now = Date.now();
            if(!en.isCharging && now - en.lastShot > 1800) { en.isCharging = true; en.chargeStart = now; }
            if(en.isCharging && now - en.chargeStart > 1200) {
                enemyLasers.push({ x: en.x, y: en.y, vx: Math.cos(a)*10, vy: Math.sin(a)*10 });
                en.lastShot = now; en.isCharging = false; shake = 12;
            }
        }
        if(Math.hypot(player.x-en.x, player.y-en.y) < en.size) player.alive = false;
    });

    enemyLasers.forEach((l, i) => {
        l.x += l.vx; l.y += l.vy;
        if(Math.hypot(l.x-player.x, l.y-player.y) < 15) player.alive = false;
        if(l.x<0 || l.x>900 || l.y<0 || l.y>550) enemyLasers.splice(i, 1);
    });

    if(aliveCount === 0 && !levelLoading) { 
        score += currentLevel * 50; currentLevel++; initLevel(currentLevel); document.getElementById('score').innerText = score; 
    }

    if(!player.alive) { 
        msgOverlay.innerHTML = `<div style="background: rgba(0,0,0,0.85); padding: 40px; border-radius: 20px; border: 2px solid var(--danger);"><div style="color:var(--danger); font-size: 4rem; margin-bottom: 10px;">WASTED</div><div style="font-size: 1.2rem; margin-bottom: 20px; color: white;">FINAL SCORE: ${score}</div><button onclick="respawn()" style="pointer-events:auto; padding:15px 40px; cursor:pointer; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: bold;">RESPAWN</button></div>`; 
    }
}

// --- DRAWING (FIXED FACES) ---
function drawEntity(x, y, angle, color, size) {
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(angle);
    // Body
    ctx.fillStyle = color;
    ctx.fillRect(-size/2, -size/2, size, size);
    // Eyes (The Face)
    ctx.fillStyle = "white";
    ctx.fillRect(size/4, -size/3, size/4, size/4);
    ctx.fillRect(size/4, size/12, size/4, size/4);
    ctx.restore();
}

function draw() {
    ctx.save();
    if(shake > 0.5) ctx.translate(Math.random()*shake-shake/2, Math.random()*shake-shake/2);
    ctx.clearRect(0, 0, 900, 550);

    particles.forEach(p => { ctx.fillStyle = p.color; ctx.globalAlpha = p.life; ctx.fillRect(p.x, p.y, 4, 4); });
    ctx.globalAlpha = 1.0;
    let pulse = Math.sin(Date.now() * 0.01) * 2;

    enemyLasers.forEach(l => { ctx.fillStyle = "#ff00ff"; ctx.fillRect(l.x-8, l.y-3, 16, 6); });
    projectiles.forEach(p => {
        ctx.fillStyle = p.onGround ? "gold" : weapon.color;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.onGround ? 7 : 6 + pulse, 0, Math.PI*2); ctx.fill();
        if(p.onGround) { ctx.shadowBlur = 10; ctx.shadowColor = "gold"; ctx.stroke(); ctx.shadowBlur = 0; }
    });

    enemies.forEach(en => { if(en.alive) {
        let a = Math.atan2(player.y-en.y, player.x-en.x);
        if(en.isBoss) {
            if(en.isCharging) {
                let ct = Date.now() - en.chargeStart;
                ctx.beginPath(); if(ct < 900) ctx.setLineDash([5, 5]);
                ctx.moveTo(en.x, en.y); ctx.lineTo(en.x + Math.cos(a)*1000, en.y + Math.sin(a)*1000);
                ctx.strokeStyle = ct > 900 ? "rgba(255, 0, 0, 1)" : "rgba(255, 0, 0, 0.4)";
                ctx.lineWidth = ct > 900 ? 5 : 2; ctx.stroke(); ctx.setLineDash([]);
            }
            ctx.strokeStyle = "red"; ctx.lineWidth = 4; ctx.strokeRect(en.x-30, en.y-30, 60, 60);
            ctx.fillStyle = "red"; ctx.fillRect(en.x-30, en.y-45, (en.hp/8)*60, 5);
        }
        drawEntity(en.x, en.y, a, "#f85149", en.size);
    }});

    if(player.alive) {
        if(player.flash > 0) { 
            ctx.fillStyle = `rgba(255,255,255,${player.flash/6})`; 
            ctx.beginPath(); ctx.arc(player.x+Math.cos(player.angle)*25, player.y+Math.sin(player.angle)*25, 45, 0, Math.PI*2); 
            ctx.fill(); player.flash--; 
        }
        drawEntity(player.x, player.y, player.angle, "#58a6ff", 24);
    }
    ctx.restore();
    update();
    requestAnimationFrame(draw);
}

initLevel(1);
draw();
</script>
</body>
</html>
